# é˜¿é‡Œäº‘æœåŠ¡å™¨æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤
# è¯·åœ¨ä½ çš„æœåŠ¡å™¨æ§åˆ¶å°ä¸­é€æ­¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤

# 1. æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
echo "ğŸš€ å¼€å§‹éƒ¨ç½²Flask + Reactå…¨æ ˆé¡¹ç›®"
uname -a
cat /etc/os-release

# 2. æ›´æ–°ç³»ç»Ÿ
yum update -y

# 3. å®‰è£…åŸºç¡€ä¾èµ–
yum install -y git curl wget vim python3 python3-pip

# 4. å®‰è£…Node.js (ARM64ç‰ˆæœ¬)
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# 5. å®‰è£…Docker
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 6. å®‰è£…Docker Compose (ARM64)
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-aarch64" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 7. å…‹éš†é¡¹ç›®
cd /opt
git clone https://github.com/Yanyu779/flask-react-fullstack.git
cd flask-react-fullstack

# 8. åˆ›å»ºARM64 Dockerfile (åç«¯)
cat > backend/Dockerfile.arm64 << 'EOF'
FROM python:3.9-slim
RUN apt-get update && apt-get install -y gcc && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
EXPOSE 5000
CMD ["python", "run.py"]
EOF

# 9. åˆ›å»ºARM64 Dockerfile (å‰ç«¯)
cat > frontend/Dockerfile.arm64 << 'EOF'
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
EOF

# 10. åˆ›å»ºDocker Composeé…ç½®
cat > docker-compose.arm64.yml << 'EOF'
version: '3.8'
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.arm64
    restart: always
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=sqlite:///app.db
    volumes:
      - ./backend/instance:/app/instance

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.arm64
    restart: always
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://8.140.211.70:5000/api
    depends_on:
      - backend

  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
EOF

# 11. åˆ›å»ºNginxé…ç½®
cat > nginx.conf << 'EOF'
events {
    worker_connections 1024;
}
http {
    upstream backend {
        server backend:5000;
    }
    upstream frontend {
        server frontend:3000;
    }
    server {
        listen 80;
        server_name 8.140.211.70;
        location /api {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
EOF

# 12. é…ç½®ç¯å¢ƒå˜é‡
cat > .env.production << 'EOF'
FLASK_ENV=production
SECRET_KEY=your-secret-key-here-change-this
DATABASE_URL=sqlite:///app.db
REACT_APP_API_URL=http://8.140.211.70/api
EOF

# 13. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.arm64.yml up --build -d

# 14. é…ç½®é˜²ç«å¢™
if command -v firewall-cmd &> /dev/null; then
    firewall-cmd --permanent --add-port=80/tcp
    firewall-cmd --permanent --add-port=443/tcp
    firewall-cmd --permanent --add-port=22/tcp
    firewall-cmd --reload
fi

# 15. ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30

# 16. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.arm64.yml ps

# 17. æµ‹è¯•æœåŠ¡
curl http://localhost:5000/api/users
curl http://localhost:80

echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
echo "è®¿é—®åœ°å€: http://8.140.211.70"
echo "APIåœ°å€: http://8.140.211.70/api/users"