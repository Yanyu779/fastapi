# Apollo配置中心Python客户端Demo - 使用指南

## 🎯 项目概述

这是一个完整的Apollo配置中心Python客户端示例，提供了连接Apollo配置中心、获取配置、监听配置变更等完整功能。

## 📦 项目文件

| 文件 | 说明 |
|------|------|
| `requirements.txt` | Python依赖包列表 |
| `config.py` | 配置管理类 |
| `apollo_client.py` | Apollo客户端核心实现 |
| `demo.py` | 完整功能演示 |
| `simple_demo.py` | 简化示例 |
| `test_apollo.py` | 单元测试 |
| `test_basic.py` | 基础测试（无需依赖） |
| `run_demo.sh` | 启动脚本 |
| `.env.example` | 环境变量模板 |
| `README.md` | 英文说明文档 |
| `项目总览.md` | 中文项目总览 |
| `使用指南.md` | 本文件 |

## 🚀 快速开始

### 1. 环境准备

```bash
# 进入项目目录
cd apollo_demo

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置设置

```bash
# 复制环境变量文件
cp .env.example .env

# 编辑配置文件（根据需要修改）
vim .env
```

### 3. 运行Demo

#### 方式一：使用启动脚本（推荐）
```bash
./run_demo.sh
```

#### 方式二：直接运行
```bash
# 完整交互式Demo
python demo.py

# 简单示例
python simple_demo.py

# 快速开始
python simple_demo.py quick
```

## 📋 核心功能演示

### 1. 基础配置获取

```python
from config import ApolloConfig
from apollo_client import ApolloClient

# 创建配置和客户端
config = ApolloConfig()
client = ApolloClient(config)

# 获取单个配置
db_url = client.get_config('database.url', 'localhost:3306')
print(f"数据库URL: {db_url}")

# 获取所有配置
all_configs = client.get_all_configs()
print(f"所有配置: {all_configs}")
```

### 2. 配置变更监听

```python
def on_config_change(key, old_value, new_value):
    print(f"配置变更: {key} = {old_value} -> {new_value}")

# 添加监听器
client.add_listener('database.url', on_config_change)
client.add_listener('redis.host', on_config_change)

# 开始监听
client.start_long_polling()

# 停止监听
client.stop_long_polling()
```

### 3. 上下文管理器

```python
with ApolloClient(config) as client:
    # 在上下文管理器中使用客户端
    value = client.get_config('test.key', 'default_value')
    print(f"配置值: {value}")
    # 退出时自动清理资源
```

## 🔧 配置参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `APOLLO_SERVER_URL` | Apollo服务器地址 | `http://localhost:8080` |
| `APOLLO_APP_ID` | 应用ID | `demo-app` |
| `APOLLO_CLUSTER` | 集群名称 | `default` |
| `APOLLO_NAMESPACE` | 命名空间 | `application` |
| `APOLLO_ENABLE_LONG_POLLING` | 是否启用长轮询 | `true` |
| `APOLLO_POLLING_INTERVAL` | 轮询间隔（秒） | `30` |
| `APOLLO_TIMEOUT` | 超时时间（秒） | `30` |
| `APOLLO_ENABLE_CACHE` | 是否启用缓存 | `true` |
| `APOLLO_CACHE_DIR` | 缓存目录 | `./apollo_cache` |

## 🧪 测试

### 基础测试（无需依赖）
```bash
python3 test_basic.py
```

### 完整测试（需要安装依赖）
```bash
# 先安装依赖
pip install -r requirements.txt

# 运行测试
python test_apollo.py
```

## 📚 使用场景

### 1. 应用配置管理
```python
# 获取应用配置
app_name = client.get_config('app.name', 'my-app')
debug_mode = client.get_config('app.debug', 'false').lower() == 'true'
log_level = client.get_config('app.log_level', 'INFO')
```

### 2. 数据库配置
```python
# 获取数据库配置
db_url = client.get_config('database.url', 'localhost:3306')
db_user = client.get_config('database.username', 'root')
db_pass = client.get_config('database.password', '')
max_connections = int(client.get_config('database.max_connections', '10'))
```

### 3. 缓存配置
```python
# 获取Redis配置
redis_host = client.get_config('redis.host', 'localhost')
redis_port = int(client.get_config('redis.port', '6379'))
redis_db = int(client.get_config('redis.db', '0'))
```

## 🔍 故障排除

### 常见问题

1. **连接失败**
   - 检查Apollo服务器地址
   - 确认网络连接正常
   - 验证防火墙设置

2. **配置获取失败**
   - 检查AppId是否正确
   - 确认命名空间存在
   - 验证配置项已创建

3. **监听器不工作**
   - 确认长轮询已启动
   - 检查监听器注册正确
   - 验证Apollo服务器支持长轮询

### 调试技巧

1. **启用详细日志**
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

2. **检查缓存文件**
```bash
ls -la apollo_cache/
cat apollo_cache/demo-app_application.json
```

3. **测试网络连接**
```bash
curl http://your-apollo-server:8080/configs/demo-app/default/application
```

## 🎯 Apollo服务器设置

### 使用Docker启动Apollo

```bash
# 克隆Apollo项目
git clone https://github.com/apolloconfig/apollo.git
cd apollo

# 启动Apollo
docker-compose up -d
```

### 访问Apollo控制台

- 地址：http://localhost:8070
- 用户名：apollo
- 密码：admin

### 创建测试配置

1. 登录Apollo控制台
2. 创建应用（AppId: demo-app）
3. 在application命名空间添加配置：
   - `database.url`: `localhost:3306`
   - `redis.host`: `localhost`
   - `app.name`: `demo-app`

## 📖 扩展开发

### 1. 添加配置验证
```python
def validate_config(key, value):
    if key == 'database.url' and not value.startswith('jdbc:'):
        raise ValueError(f"Invalid database URL: {value}")
    return value
```

### 2. 支持JSON配置
```python
import json

def get_json_config(client, key, default='{}'):
    value = client.get_config(key, default)
    return json.loads(value)
```

### 3. 集成到Flask应用
```python
from flask import Flask
from apollo_client import ApolloClient
from config import ApolloConfig

app = Flask(__name__)

# 初始化Apollo客户端
config = ApolloConfig()
apollo_client = ApolloClient(config)

@app.route('/config/<key>')
def get_config(key):
    return {'value': apollo_client.get_config(key, '')}
```

## 🎉 总结

这个Apollo配置中心Python客户端Demo提供了：

- ✅ 完整的Apollo客户端实现
- ✅ 配置获取和缓存功能
- ✅ 配置变更监听机制
- ✅ 上下文管理器支持
- ✅ 详细的文档和示例
- ✅ 完整的测试覆盖
- ✅ 易于使用的启动脚本

通过这个Demo，您可以快速了解如何在Python项目中集成Apollo配置中心，实现配置的统一管理和动态更新。

---

**注意：** 这是一个演示项目，生产环境使用时请根据实际需求进行调整和优化。