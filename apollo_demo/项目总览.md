# Apollo配置中心Python客户端Demo - 项目总览

## 📁 项目结构

```
apollo_demo/
├── requirements.txt          # Python依赖包
├── config.py                # 配置管理类
├── apollo_client.py         # Apollo客户端核心实现
├── demo.py                  # 完整功能演示
├── simple_demo.py           # 简化示例
├── test_apollo.py           # 单元测试
├── run_demo.sh              # 启动脚本
├── .env.example             # 环境变量模板
├── README.md                # 英文说明文档
└── 项目总览.md              # 中文项目总览
```

## 🚀 快速开始

### 1. 环境准备

```bash
# 进入项目目录
cd apollo_demo

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置设置

```bash
# 复制环境变量文件
cp .env.example .env

# 编辑配置文件
vim .env
```

修改 `.env` 文件中的关键配置：
```bash
# Apollo服务器地址
APOLLO_SERVER_URL=http://your-apollo-server:8080

# 应用ID
APOLLO_APP_ID=your-app-id

# 命名空间
APOLLO_NAMESPACE=application
```

### 3. 运行Demo

#### 方式一：使用启动脚本（推荐）
```bash
./run_demo.sh
```

#### 方式二：直接运行
```bash
# 完整交互式Demo
python demo.py

# 简单示例
python simple_demo.py

# 快速开始
python simple_demo.py quick
```

## 📋 核心功能

### 1. 配置获取
- ✅ 获取单个配置项
- ✅ 获取所有配置
- ✅ 支持默认值
- ✅ 异常处理

### 2. 配置监听
- ✅ 长轮询监听配置变更
- ✅ 自定义监听器回调
- ✅ 实时配置更新

### 3. 缓存机制
- ✅ 本地配置缓存
- ✅ 缓存文件持久化
- ✅ 缓存自动更新

### 4. 上下文管理
- ✅ 自动资源清理
- ✅ 异常安全处理

## 🔧 核心类说明

### ApolloConfig 类
负责管理Apollo连接配置，支持环境变量配置。

**主要功能：**
- 读取环境变量配置
- 提供默认配置值
- 配置验证和格式化

**使用示例：**
```python
from config import ApolloConfig

config = ApolloConfig()
config.print_config()  # 打印当前配置
```

### ApolloClient 类
Apollo客户端的核心实现，提供完整的配置管理功能。

**主要功能：**
- 连接Apollo服务器
- 获取和缓存配置
- 监听配置变更
- 管理监听器

**使用示例：**
```python
from apollo_client import ApolloClient
from config import ApolloConfig

config = ApolloConfig()
client = ApolloClient(config)

# 获取配置
value = client.get_config('database.url', 'localhost:3306')

# 添加监听器
def on_change(key, old_value, new_value):
    print(f"配置变更: {key} = {old_value} -> {new_value}")

client.add_listener('database.url', on_change)
client.start_long_polling()
```

## 📖 使用场景

### 1. 基础配置获取
```python
# 获取数据库配置
db_url = client.get_config('database.url', 'localhost:3306')
db_user = client.get_config('database.username', 'root')
db_pass = client.get_config('database.password', '')

# 获取Redis配置
redis_host = client.get_config('redis.host', 'localhost')
redis_port = int(client.get_config('redis.port', '6379'))
```

### 2. 配置变更监听
```python
def database_config_handler(key, old_value, new_value):
    if key == 'database.url':
        # 重新连接数据库
        reconnect_database(new_value)
    elif key == 'database.pool_size':
        # 调整连接池大小
        adjust_connection_pool(int(new_value))

client.add_listener('database.url', database_config_handler)
client.add_listener('database.pool_size', database_config_handler)
client.start_long_polling()
```

### 3. 应用配置管理
```python
# 获取应用配置
app_name = client.get_config('app.name', 'my-app')
debug_mode = client.get_config('app.debug', 'false').lower() == 'true'
log_level = client.get_config('app.log_level', 'INFO')

# 获取所有配置
all_configs = client.get_all_configs()
print(f"应用 {app_name} 的配置: {all_configs}")
```

## 🧪 测试

运行单元测试：
```bash
python test_apollo.py
```

测试覆盖的功能：
- ✅ 配置类测试
- ✅ 客户端基本功能测试
- ✅ 监听器管理测试
- ✅ 缓存操作测试
- ✅ 上下文管理器测试

## 🔍 故障排除

### 常见问题

1. **连接失败**
   - 检查Apollo服务器地址是否正确
   - 确认网络连接正常
   - 验证防火墙设置

2. **配置获取失败**
   - 检查AppId是否正确
   - 确认命名空间存在
   - 验证配置项已创建

3. **监听器不工作**
   - 确认长轮询已启动
   - 检查监听器注册正确
   - 验证Apollo服务器支持长轮询

### 调试技巧

1. **启用详细日志**
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

2. **检查缓存文件**
```bash
ls -la apollo_cache/
cat apollo_cache/demo-app_application.json
```

3. **测试网络连接**
```bash
curl http://your-apollo-server:8080/configs/demo-app/default/application
```

## 📚 扩展开发

### 1. 添加新功能
- 配置加密/解密
- 配置验证规则
- 多环境支持
- 配置热重载

### 2. 集成到现有项目
```python
# 在Flask应用中使用
from flask import Flask
from apollo_client import ApolloClient
from config import ApolloConfig

app = Flask(__name__)

# 初始化Apollo客户端
config = ApolloConfig()
apollo_client = ApolloClient(config)

@app.route('/config/<key>')
def get_config(key):
    return {'value': apollo_client.get_config(key, '')}
```

### 3. 自定义配置类型
```python
import json

# JSON配置支持
def get_json_config(client, key, default='{}'):
    value = client.get_config(key, default)
    return json.loads(value)

# 数字配置支持
def get_int_config(client, key, default=0):
    value = client.get_config(key, str(default))
    return int(value)
```

## 📄 许可证

MIT License - 可自由使用、修改和分发。

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目！

---

**注意：** 这是一个演示项目，生产环境使用时请根据实际需求进行调整和优化。